{% extends 'main/content.html' %}
{% load static %}
{% block title %}
5.6. Отношение один ко многим (One to Many)
{% endblock %}
    {% block head %}Отношение один ко многим (One to Many){% endblock %}
{% block content %}   
    <p>Рассмотрим организацию связи один ко многим, при которой одна главная сущность может быть связаны с несколькими зависимыми сущностями. 
    Например, одна компания может выпускать несколько товаров:</p>
    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <div><div id="highlighter_300447" class="syntaxhighlighter  py"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help"></a></strong></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">django.db </code><code class="py keyword">import</code> <code class="py plain">models</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">class</code> <code class="py plain">Company(models.Model):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">name </code><code class="py keyword">=</code> <code class="py plain">models.CharField(max_length</code><code class="py keyword">=</code><code class="py value">30</code><code class="py plain">)</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py keyword">class</code> <code class="py plain">Product(models.Model):</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">company </code><code class="py keyword">=</code> <code class="py plain">models.ForeignKey(Company, on_delete </code><code class="py keyword">=</code> <code class="py plain">models.CASCADE)</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">name </code><code class="py keyword">=</code> <code class="py plain">models.CharField(max_length</code><code class="py keyword">=</code><code class="py value">30</code><code class="py plain">)</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">price </code><code class="py keyword">=</code> <code class="py plain">models.IntegerField()</code></div></div></td></tr></tbody></table></div></div>
    </nav>
    <p>В данном случае модель Company представляет производителя и является главной моделью, а модель Product представляет товар компании и является зависимой моделью.</p>
    <p>Конструктор типа <code>models.ForeignKey</code> настраивает связь с главной сущностью. Первый параметр указывает, с какой моделью будет 
    создаваться связь - в данном случае это модель Company. Второй параметр - <code>on_delete</code> задает опцию удаления объекта текущей модели при удалении 
    связанного объекта главной модели. Всего для параметра on_delete мы можем использовать следующие значения:</p>
    <ul>
    <li><p><strong>models.CASCADE</strong>: автоматически удаляет строку из зависимой таблицы, если удаляется связанная строка из главной таблицы</p></li>
    <li><p><strong>models.PROTECT</strong>: блокирует удаление строки из главной таблицы, если с ней связаны какие-либо строки из зависимой таблицы</p></li>
    <li><p><strong>models.SET_NULL</strong>: устанавливает NULL при удалении связанной строка из главной таблицы</p></li>
    <li><p><strong>models.SET_DEFAULT</strong>: устанавливает значение по умолчанию для внешнео ключа в зависимой таблице. В этом случае для этого столбца должно быть задано значение по умолчанию</p></li>
    <li><p><strong>models.DO_NOTHING</strong>: при удалении связанной строки из главной таблицы не производится никаких действий в зависимой таблице</p></li>
    </ul>
    <p>И в результате миграции в базе данных SQLite будут создаваться следующие таблицы:</p>
    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <div><div id="highlighter_179462" class="syntaxhighlighter  sql"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help"></a></strong></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">CREATE</code> <code class="sql keyword">TABLE</code> <code class="sql plain">`firstapp_company` (</code></div><div class="line number2 index1 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">`id`&nbsp;&nbsp;&nbsp; </code><code class="sql keyword">integer</code> <code class="sql color1">NOT</code> <code class="sql color1">NULL</code> <code class="sql keyword">PRIMARY</code> <code class="sql keyword">KEY</code> <code class="sql plain">AUTOINCREMENT,</code></div><div class="line number3 index2 alt2"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">`</code><code class="sql keyword">name</code><code class="sql plain">`&nbsp; </code><code class="sql keyword">varchar</code><code class="sql plain">(30) </code><code class="sql color1">NOT</code> <code class="sql color1">NULL</code></div><div class="line number4 index3 alt1"><code class="sql plain">);</code></div><div class="line number5 index4 alt2"><code class="sql keyword">CREATE</code> <code class="sql keyword">TABLE</code> <code class="sql plain">`firstapp_product` (</code></div><div class="line number6 index5 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">`id`&nbsp;&nbsp;&nbsp; </code><code class="sql keyword">integer</code> <code class="sql color1">NOT</code> <code class="sql color1">NULL</code> <code class="sql keyword">PRIMARY</code> <code class="sql keyword">KEY</code> <code class="sql plain">AUTOINCREMENT,</code></div><div class="line number7 index6 alt2"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">`</code><code class="sql keyword">name</code><code class="sql plain">`&nbsp; </code><code class="sql keyword">varchar</code><code class="sql plain">(30) </code><code class="sql color1">NOT</code> <code class="sql color1">NULL</code><code class="sql plain">,</code></div><div class="line number8 index7 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">`price` </code><code class="sql keyword">integer</code> <code class="sql color1">NOT</code> <code class="sql color1">NULL</code><code class="sql plain">,</code></div><div class="line number9 index8 alt2"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">`company_id`&nbsp;&nbsp;&nbsp; </code><code class="sql keyword">integer</code> <code class="sql color1">NOT</code> <code class="sql color1">NULL</code><code class="sql plain">,</code></div><div class="line number10 index9 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql keyword">FOREIGN</code> <code class="sql keyword">KEY</code><code class="sql plain">(`company_id`) </code><code class="sql keyword">REFERENCES</code> <code class="sql plain">`firstapp_company`(`id`) DEFERRABLE INITIALLY DEFERRED</code></div><div class="line number11 index10 alt2"><code class="sql plain">);</code></div></div></td></tr></tbody></table></div></div>
    </nav>
    <h3>Операции с моделями</h3>
    <p>Из определения таблиц мы видим, что Product связана с таблицей Company через столбец "company_id". Однако в самом определении модели Product 
    есть поле <code>company</code>, через которое можно получить связанную сущность:</p>
    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <div><div id="highlighter_316872" class="syntaxhighlighter  py"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help"></a></strong></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py comments"># получение id связанной с товаром компании</code></div><div class="line number2 index1 alt1"><code class="py plain">Product.objects.get(</code><code class="py functions">id</code><code class="py keyword">=</code><code class="py value">1</code><code class="py plain">).company.</code><code class="py functions">id</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py comments"># получение названия связанной с товаром компании</code></div><div class="line number5 index4 alt2"><code class="py plain">Product.objects.get(</code><code class="py functions">id</code><code class="py keyword">=</code><code class="py value">1</code><code class="py plain">).company.name</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py comments"># получение товаров, которые принадлежат к компании "Apple"</code></div><div class="line number8 index7 alt1"><code class="py plain">Product.objects.</code><code class="py functions">filter</code><code class="py plain">(company__name</code><code class="py keyword">=</code><code class="py string">"Apple"</code><code class="py plain">)</code></div></div></td></tr></tbody></table></div></div>
    </nav>
    <p>С помощью выражения <code>модель__свойство</code> (два подчеркивания) можно использовать свойство главной модели для фильтрации по объектам зависимой модели.</p>
    <p>Хотя с точки зрения модели Company она не имеет никаких свойств, которые бы связывали бы ее с моделью Product.  
    Но с помощью синтаксиса <code>"главная_модель"."зависимая_модель"_set</code> можно изменить направление связи.</p>
    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <div><div id="highlighter_885970" class="syntaxhighlighter  py"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help"></a></strong></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">.models </code><code class="py keyword">import</code> <code class="py plain">Company, Product</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py plain">apple </code><code class="py keyword">=</code> <code class="py plain">Company.objects.get(name</code><code class="py keyword">=</code><code class="py string">"Apple"</code><code class="py plain">)</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py comments"># получение всех товаров</code></div><div class="line number6 index5 alt1"><code class="py plain">apple.product_set.</code><code class="py functions">all</code><code class="py plain">()</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py comments"># получение количества товаров</code></div><div class="line number9 index8 alt2"><code class="py plain">apple.product_set.count()</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="py comments"># получение товаров, название которых начинается на "iPhone"</code></div><div class="line number12 index11 alt1"><code class="py plain">apple.product_set.</code><code class="py functions">filter</code><code class="py plain">(name__startwith</code><code class="py keyword">=</code><code class="py string">"iPhone"</code><code class="py plain">)</code></div></div></td></tr></tbody></table></div></div>
    </nav>
    <p>Причем с помощью выражения <code>_set</code> можно выполнять операции добавления, изменения, удаления объектов зависимой модели из главной модели.</p>
    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <div><div id="highlighter_232303" class="syntaxhighlighter  py"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help"></a></strong></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py comments"># создаем объект Company</code></div><div class="line number2 index1 alt1"><code class="py plain">apple </code><code class="py keyword">=</code> <code class="py plain">Company.objects.create(name</code><code class="py keyword">=</code><code class="py string">"Apple"</code><code class="py plain">)</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py comments"># создание товара определенной компании</code></div><div class="line number6 index5 alt1"><code class="py plain">apple.product_set.create(name</code><code class="py keyword">=</code><code class="py string">"iPhone 8"</code><code class="py plain">, price</code><code class="py keyword">=</code><code class="py value">67890</code><code class="py plain">)</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py comments"># отдельное создание объекта с последующим добавлением</code></div><div class="line number9 index8 alt2"><code class="py plain">ipad </code><code class="py keyword">=</code> <code class="py plain">Product(name</code><code class="py keyword">=</code><code class="py string">"iPad"</code><code class="py plain">, price</code><code class="py keyword">=</code><code class="py value">34560</code><code class="py plain">)</code></div><div class="line number10 index9 alt1"><code class="py comments"># при добавлении необходимо указать параметр bulk =False</code></div><div class="line number11 index10 alt2"><code class="py plain">apple.product_set.add(ipad, bulk </code><code class="py keyword">=</code><code class="py color1">False</code><code class="py plain">)</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="py comments"># исключает из компании все товары, </code></div><div class="line number14 index13 alt1"><code class="py comments"># при этом товары остаются в бд, просто им не назначена компания</code></div><div class="line number15 index14 alt2"><code class="py comments"># работает, если в зависимой модели ForeignKey(Company, null = True)</code></div><div class="line number16 index15 alt1"><code class="py comments"># apple.product_set.clear()</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="py comments"># то же самое, только в отношении одного объекта</code></div><div class="line number19 index18 alt2"><code class="py comments"># ipad = Product.objects.get(name="iPad")</code></div><div class="line number20 index19 alt1"><code class="py comments"># apple.product_set.remove(ipad)</code></div></div></td></tr></tbody></table></div></div>
    </nav>
    <p>Стоит отметить три метода:</p>
    <ul>
    <li><p><strong>add()</strong>: добавляет связь между объектом зависимой модели и объектом главной модели. В своей сути этот метод 
    фактически вызывает для модели метод <code>update()</code> для добавления связи. Однако это требует, чтобы обе модели уже были в базе данных. И чтобы 
    обойти это ограничение, применяется параметр <code>bulk=False</code>, для того, чтобы объект зависимой модели сразу был добавлен и для него была установлена связь.</p>
    </li>
    <li><p><strong>clear()</strong>: удаляет связь между всеми объектами зависимой модели и объектом главной модели. При этом сами объекты зависимой модели остаются 
    в базе данных, и для их внешнего ключа устанавливается значение NULL. Поэтому данный метод будет работать, если в самой зависимой модели при установки связи 
    использовался параметр <code>null=True</code>: <code>ForeignKey(Company, null = True)</code>.</p>
    </li>
    <li><p><strong>remove()</strong>: также, как и <code>clear()</code> удаляет связь, только между одним объектом зависимой модели и объектом главной модели. 
    При этом также все объекты остаются в бд. И также в самой зависимой модели при установки связи должен использоваться параметр <code>null=True</code></p>
    </li>
    </ul>
    


{% endblock %}
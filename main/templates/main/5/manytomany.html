{% extends 'main/content.html' %}
{% load static %}
{% block title %}
5.7. Отношение многие ко многим (Many to Many)
{% endblock %}
    {% block head %}Отношение многие ко многим (Many to Many){% endblock %}
{% block content %}
    <p>Связь многие ко многим описывает ситуацию, когда объект первой модели может одновременно ассоциироваться с несколькими объектами второй модели. И наоборот, 
    один объект второй модели может также одновременно быть ассоциирован с несколькими объектами первой модели. Например, один студент может посещать несколько 
    курсов, а один курс могут посещать несколько студентов.</p>
    <p>Для создания отношения многие ко многим применяется тип <strong>ManyToManyField</strong>.</p>
    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <div><div id="highlighter_136105" class="syntaxhighlighter  py"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help"></a></strong></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">django.db </code><code class="py keyword">import</code> <code class="py plain">models</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">class</code> <code class="py plain">Course(models.Model):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">name </code><code class="py keyword">=</code> <code class="py plain">models.CharField(max_length</code><code class="py keyword">=</code><code class="py value">30</code><code class="py plain">)</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py keyword">class</code> <code class="py plain">Student(models.Model):</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">name </code><code class="py keyword">=</code> <code class="py plain">models.CharField(max_length</code><code class="py keyword">=</code><code class="py value">30</code><code class="py plain">)</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">courses </code><code class="py keyword">=</code> <code class="py plain">models.ManyToManyField(Course)</code></div></div></td></tr></tbody></table></div></div>
    </nav>
        <p>В конструктор <code>models.ManyToManyField</code> передается сущность, с которой устанавливается отношение многие ко многим. В результате будет 
    создаваться промежуточная таблица, через которую собственно и будет осуществляться связь.</p>
    <p>В результате миграции в базе данных SQLite будут создаваться следующие таблицы:</p>
    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <div><div id="highlighter_800546" class="syntaxhighlighter  sql"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help"></a></strong></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">CREATE</code> <code class="sql keyword">TABLE</code> <code class="sql plain">`firstapp_course` (</code></div><div class="line number2 index1 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">`id`&nbsp;&nbsp;&nbsp; </code><code class="sql keyword">integer</code> <code class="sql color1">NOT</code> <code class="sql color1">NULL</code> <code class="sql keyword">PRIMARY</code> <code class="sql keyword">KEY</code> <code class="sql plain">AUTOINCREMENT,</code></div><div class="line number3 index2 alt2"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">`</code><code class="sql keyword">name</code><code class="sql plain">`&nbsp; </code><code class="sql keyword">varchar</code><code class="sql plain">(30) </code><code class="sql color1">NOT</code> <code class="sql color1">NULL</code></div><div class="line number4 index3 alt1"><code class="sql plain">);</code></div><div class="line number5 index4 alt2"><code class="sql keyword">CREATE</code> <code class="sql keyword">TABLE</code> <code class="sql plain">`firstapp_student` (</code></div><div class="line number6 index5 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">`id`&nbsp;&nbsp;&nbsp; </code><code class="sql keyword">integer</code> <code class="sql color1">NOT</code> <code class="sql color1">NULL</code> <code class="sql keyword">PRIMARY</code> <code class="sql keyword">KEY</code> <code class="sql plain">AUTOINCREMENT,</code></div><div class="line number7 index6 alt2"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">`</code><code class="sql keyword">name</code><code class="sql plain">`&nbsp; </code><code class="sql keyword">varchar</code><code class="sql plain">(30) </code><code class="sql color1">NOT</code> <code class="sql color1">NULL</code></div><div class="line number8 index7 alt1"><code class="sql plain">);</code></div><div class="line number9 index8 alt2"><code class="sql keyword">CREATE</code> <code class="sql keyword">TABLE</code> <code class="sql plain">`firstapp_student_courses` (</code></div><div class="line number10 index9 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">`id`&nbsp;&nbsp;&nbsp; </code><code class="sql keyword">integer</code> <code class="sql color1">NOT</code> <code class="sql color1">NULL</code> <code class="sql keyword">PRIMARY</code> <code class="sql keyword">KEY</code> <code class="sql plain">AUTOINCREMENT,</code></div><div class="line number11 index10 alt2"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">`student_id`&nbsp;&nbsp;&nbsp; </code><code class="sql keyword">integer</code> <code class="sql color1">NOT</code> <code class="sql color1">NULL</code><code class="sql plain">,</code></div><div class="line number12 index11 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">`course_id` </code><code class="sql keyword">integer</code> <code class="sql color1">NOT</code> <code class="sql color1">NULL</code><code class="sql plain">,</code></div><div class="line number13 index12 alt2"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql keyword">FOREIGN</code> <code class="sql keyword">KEY</code><code class="sql plain">(`student_id`) </code><code class="sql keyword">REFERENCES</code> <code class="sql plain">`firstapp_student`(`id`) DEFERRABLE INITIALLY DEFERRED,</code></div><div class="line number14 index13 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql keyword">FOREIGN</code> <code class="sql keyword">KEY</code><code class="sql plain">(`course_id`) </code><code class="sql keyword">REFERENCES</code> <code class="sql plain">`firstapp_course`(`id`) DEFERRABLE INITIALLY DEFERRED</code></div><div class="line number15 index14 alt2"><code class="sql plain">);</code></div></div></td></tr></tbody></table></div></div>
    </nav>
        <p>В данном случае "firstapp_student_courses" выступает в качестве связующей таблицы. Она называется по шаблону <code>имя_таблицы + имя_связующего_поля_из_таблицы</code>.</p>
    <h3>Операции с моделями</h3>
    <p>Через свойство <code>courses</code> в модели Student мы можем получать связанные со студентом курсы и управлять ими.</p>
    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <div><div id="highlighter_179384" class="syntaxhighlighter  py"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help"></a></strong></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py comments"># создадим студента</code></div><div class="line number2 index1 alt1"><code class="py plain">tom </code><code class="py keyword">=</code> <code class="py plain">Student.objects.create(name</code><code class="py keyword">=</code><code class="py string">"Tom"</code><code class="py plain">)</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py comments"># создадим один курс и добавим его в список курсов Тома</code></div><div class="line number5 index4 alt2"><code class="py plain">tom.courses.create(name</code><code class="py keyword">=</code><code class="py string">"Algebra"</code><code class="py plain">)</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py comments"># получим все курсы студента</code></div><div class="line number8 index7 alt1"><code class="py plain">courses </code><code class="py keyword">=</code> <code class="py plain">Student.objects.get(name</code><code class="py keyword">=</code><code class="py string">"Tom"</code><code class="py plain">).courses.</code><code class="py functions">all</code><code class="py plain">()</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py comments"># получаем всех студентов, которые посещают курс Алгебра</code></div><div class="line number11 index10 alt2"><code class="py plain">studes </code><code class="py keyword">=</code> <code class="py plain">Student.objects.</code><code class="py functions">filter</code><code class="py plain">(courses__name</code><code class="py keyword">=</code><code class="py string">"Algebra"</code><code class="py plain">)</code></div></div></td></tr></tbody></table></div></div>
    </nav>
        <p>Стоит отметить последний случай, где производится фильтрация студентов по посещаемому курсу. Для передачи в метод filter названия курса 
    используется параметр, название которого начинается с названия свойства, через которое идет связь со второй моделью. И далее через два знака подчеркивания указывается 
    имя свойства второй модели, например, <code>courses__name</code> или <code>courses__id</code>.</p>
    <p>Однако в данном случае мы можем получить информацию о курсах студента через свойство courses, которое определено в модели Student. Однако что если 
    мы хотим получить информацию о студентах по определенному курсу В этом случае нам надо использовать синтаксис <strong>_set</strong>.</p>
    <nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <div><div id="highlighter_941812" class="syntaxhighlighter  py"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help"></a></strong></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py comments"># создадим курс</code></div><div class="line number2 index1 alt1"><code class="py plain">python </code><code class="py keyword">=</code> <code class="py plain">Course.objects.create(name</code><code class="py keyword">=</code><code class="py string">"Python"</code><code class="py plain">)</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py comments"># создаем студента и добавляем его на курс</code></div><div class="line number5 index4 alt2"><code class="py plain">python.student_set.create(name</code><code class="py keyword">=</code><code class="py string">"Bob"</code><code class="py plain">)</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py comments"># отдельно создаем студента и добавляем его на курс</code></div><div class="line number8 index7 alt1"><code class="py plain">sam </code><code class="py keyword">=</code> <code class="py plain">Student(name</code><code class="py keyword">=</code><code class="py string">"Sam"</code><code class="py plain">)</code></div><div class="line number9 index8 alt2"><code class="py plain">sam.save()</code></div><div class="line number10 index9 alt1"><code class="py plain">python.student_set.add(sam)</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="py comments"># получим всех студентов курса</code></div><div class="line number13 index12 alt2"><code class="py plain">students </code><code class="py keyword">=</code> <code class="py plain">python.student_set.</code><code class="py functions">all</code><code class="py plain">()</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="py comments"># получим количество студентов по курсу</code></div><div class="line number16 index15 alt1"><code class="py plain">number </code><code class="py keyword">=</code> <code class="py plain">python.student_set.count()</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="py comments"># удялем с курса одного студента</code></div><div class="line number19 index18 alt2"><code class="py plain">python.student_set.remove(sam)</code></div><div class="line number20 index19 alt1">&nbsp;</div><div class="line number21 index20 alt2"><code class="py comments"># удаляем всех студентов с курса</code></div><div class="line number22 index21 alt1"><code class="py plain">python.student_set.clear()</code></div></div></td></tr></tbody></table></div></div>
    </nav>
        <p>Стоит учитывать, что не всегда такая организация связи Многие ко Многим может подойти. Например, в данном случае создается промежуточная таблица, которая 
    хранит id студента и id курса. Если нам надо в промежуточной таблице харнить еще какие-либо данные, например, дату зачисления студента на курс, его оценку и т.д., 
    то такая конфигурация не подойдет. И в этом случае будет более оптимально создать промежуточную сущность вручную, которая связана отношением один ко многим с обеими моделями.</p>
    




{% endblock %}